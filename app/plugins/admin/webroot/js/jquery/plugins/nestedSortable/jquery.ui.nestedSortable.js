(function($){$.widget("ui.nestedSortable",$.extend({},$.ui.sortable.prototype,{options:{tabSize:20,disableNesting:'ui-nestedSortable-no-nesting',errorClass:'ui-nestedSortable-error',listType:'ol',maxLevels:0,noJumpFix:0},_create:function(){if(this.noJumpFix==false)this.element.height(this.element.height());this.element.data('sortable',this.element.data('nestedSortable'));return $.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(a){this.position=this._generatePosition(a);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var o=this.options,scrolled=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!='HTML'){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-a.pageY<o.scrollSensitivity)this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop+o.scrollSpeed;else if(a.pageY-this.overflowOffset.top<o.scrollSensitivity)this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop-o.scrollSpeed;if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-a.pageX<o.scrollSensitivity)this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft+o.scrollSpeed;else if(a.pageX-this.overflowOffset.left<o.scrollSensitivity)this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft-o.scrollSpeed}else{if(a.pageY-$(document).scrollTop()<o.scrollSensitivity)scrolled=$(document).scrollTop($(document).scrollTop()-o.scrollSpeed);else if($(window).height()-(a.pageY-$(document).scrollTop())<o.scrollSensitivity)scrolled=$(document).scrollTop($(document).scrollTop()+o.scrollSpeed);if(a.pageX-$(document).scrollLeft()<o.scrollSensitivity)scrolled=$(document).scrollLeft($(document).scrollLeft()-o.scrollSpeed);else if($(window).width()-(a.pageX-$(document).scrollLeft())<o.scrollSensitivity)scrolled=$(document).scrollLeft($(document).scrollLeft()+o.scrollSpeed)}if(scrolled!==false&&$.ui.ddmanager&&!o.dropBehaviour)$.ui.ddmanager.prepareOffsets(this,a)}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+'px';if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+'px';for(var i=this.items.length-1;i>=0;i--){var b=this.items[i],itemElement=b.item[0],intersection=this._intersectsWithPointer(b);if(!intersection)continue;if(itemElement!=this.currentItem[0]&&this.placeholder[intersection==1?"next":"prev"]()[0]!=itemElement&&!$.contains(this.placeholder[0],itemElement)&&(this.options.type=='semi-dynamic'?!$.contains(this.element[0],itemElement):true)){this.direction=intersection==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(b)){this._rearrange(a,b)}else{break}this._clearEmpty(itemElement);this._trigger("change",a,this._uiHash());break}}var c=(this.placeholder[0].parentNode.parentNode&&$(this.placeholder[0].parentNode.parentNode).closest('.ui-sortable').length)?$(this.placeholder[0].parentNode.parentNode):null;var d=this._getLevel(this.placeholder);var e=this._getChildLevels(this.helper);var f=this.placeholder[0].previousSibling?$(this.placeholder[0].previousSibling):null;if(f!=null){while(f[0].nodeName.toLowerCase()!='li'||f[0]==this.currentItem[0]){if(f[0].previousSibling){f=$(f[0].previousSibling)}else{f=null;break}}}newList=document.createElement(o.listType);this.beyondMaxLevels=0;if(c!=null&&this.positionAbs.left<c.offset().left){c.after(this.placeholder[0]);this._clearEmpty(c[0]);this._trigger("change",a,this._uiHash())}else if(f!=null&&this.positionAbs.left>f.offset().left+o.tabSize){this._isAllowed(f,d+e+1);if(!f.children(o.listType).length){f[0].appendChild(newList)}f.children(o.listType)[0].appendChild(this.placeholder[0]);this._trigger("change",a,this._uiHash())}else{this._isAllowed(c,d+e)}this._contactContainers(a);if($.ui.ddmanager)$.ui.ddmanager.drag(this,a);this._trigger('sort',a,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(a,b){if(this.beyondMaxLevels){var c=this.placeholder.parent().closest(this.options.items);for(var i=this.beyondMaxLevels-1;i>0;i--){c=c.parent().closest(this.options.items)}this.placeholder.removeClass(this.options.errorClass);c.after(this.placeholder);this._trigger("change",a,this._uiHash())}$.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(o){var c=this._getItemsAsjQuery(o&&o.connected);var d=[];o=o||{};$(c).each(function(){var a=($(o.item||this).attr(o.attribute||'id')||'').match(o.expression||(/(.+)[-=_](.+)/));var b=($(o.item||this).parent(o.listType).parent('li').attr(o.attribute||'id')||'').match(o.expression||(/(.+)[-=_](.+)/));if(a)d.push((o.key||a[1]+'['+(o.key&&o.expression?a[1]:a[2])+']')+'='+(b?(o.key&&o.expression?b[1]:b[2]):'root'))});if(!d.length&&o.key){d.push(o.key+'=')}return d.join('&')},toHierarchy:function(o){o=o||{};var e=o.startDepthCount||0;var f=[];$(this.element).children('li').each(function(){var a=_recursiveItems($(this));f.push(a)});return f;function _recursiveItems(b){var c=($(b).attr(o.attribute||'id')||'').match(o.expression||(/(.+)[-=_](.+)/));if(c!=null){var d={"id":c[2]};if($(b).children(o.listType).children('li').length>0){d.children=[];$(b).children(o.listType).children('li').each(function(){var a=_recursiveItems($(this));d.children.push(a)})}return d}}},toArray:function(o){o=o||{};var d=o.startDepthCount||0;var e=[];var f=1;$(this.element).children('li').each(function(){f=_recursiveArray(this,d+1,f)});function _sortByLeft(a,b){return a['lft']-b['lft']}e=e.sort(_sortByLeft);return e;function _recursiveArray(a,b,c){right=c+1;if($(a).children(o.listType).children('li').length>0){b++;$(a).children(o.listType).children('li').each(function(){right=_recursiveArray($(this),b,right)});b--}id=($(a).attr(o.attribute||'id')).match(o.expression||(/(.+)[-=_](.+)/));if(b===d+1)pid='root';else{parentItem=($(a).parent(o.listType).parent('li').attr('id')).match(o.expression||(/(.+)[-=_](.+)/));pid=parentItem[2]}if(id!=null){e.push({"id":id[2],"parent_id":pid,"depth":b,"lft":c,"rght":right})}return c=right+1}},_clear:function(a,b){$.ui.sortable.prototype._clear.apply(this,arguments);for(var i=this.items.length-1;i>=0;i--){var c=this.items[i].item[0];this._clearEmpty(c)}return true},_clearEmpty:function(a){if(a.children[1]&&a.children[1].children.length==0){a.removeChild(a.children[1])}},_getLevel:function(a){var b=1;if(this.options.listType){var c=a.closest(this.options.listType);while(!c.is('.ui-sortable')){b++;c=c.parent().closest(this.options.listType)}}return b},_getChildLevels:function(c,d){var e=this,o=this.options,result=0;d=d||0;$(c).children(o.listType).children(o.items).each(function(a,b){result=Math.max(e._getChildLevels(b,d+1),result)});return d?result+1:result},_isAllowed:function(a,b){var o=this.options;if(a==null||!(a.hasClass(o.disableNesting))){if(o.maxLevels<b&&o.maxLevels!=0){this.placeholder.addClass(o.errorClass);this.beyondMaxLevels=b-o.maxLevels}else{this.placeholder.removeClass(o.errorClass);this.beyondMaxLevels=0}}else{this.placeholder.addClass(o.errorClass);if(o.maxLevels<b&&o.maxLevels!=0){this.beyondMaxLevels=b-o.maxLevels}else{this.beyondMaxLevels=1}}}}));$.ui.nestedSortable.prototype.options=$.extend({},$.ui.sortable.prototype.options,$.ui.nestedSortable.prototype.options)})(jQuery);